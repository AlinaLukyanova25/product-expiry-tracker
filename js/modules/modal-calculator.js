import{DateUtils}from"../utils/date-utils.js";import{createArrow}from"../utils/dom-utils.js";import{validateCalculator,calculateExpirationDate,dateToAddForm}from"../utils/date-utils.js";export class DateCalculator{constructor(){this.calculatorModal=null,this.sourceModal=null,this.context=null,this.calculatorButton=null,this.init()}init(){this.setupEventListeners()}setupEventListeners(){document.addEventListener("click",e=>{if(e.target.closest(".modal__calculator")){const modal=e.target.closest(".modal, .modal-return, .form__add");modal&&this.openCalculator(e,modal)}}),document.getElementById("backdrop-calculator")?.addEventListener("click",()=>this.closeCalculator())}openCalculator(e,modalElement){e.preventDefault(),this.calculatorButton=e.target.closest(".modal__calculator"),this.sourceModal=modalElement,this.context=modalElement.classList.contains("modal-return")?"return":modalElement.classList.contains("modal")?"modal":"form",this.setupCalculatorModal()}setupCalculatorModal(){const calculatorModal=this.createCalculatorModal();this.populateCalculator(calculatorModal),this.addCalculatorListeners(calculatorModal)}createCalculatorModal(){const formCalculator=document.querySelector(".modal-form-calculator");if(!formCalculator)return console.error("Модальное окно калькулятора не найдено"),null;const newFormCalculator=formCalculator.cloneNode(!0);return formCalculator.parentNode.replaceChild(newFormCalculator,formCalculator),this.calculatorModal=newFormCalculator,newFormCalculator}populateCalculator(calculatorModal){const html=this.createModalCalculatorComponent();if(calculatorModal.innerHTML=html,"modal"===this.context||"return"===this.context){const arrowBackToModal=createArrow();arrowBackToModal&&(calculatorModal.prepend(arrowBackToModal),arrowBackToModal.addEventListener("click",e=>this.handleArrowBack(e)))}if(calculatorModal.classList.add("open"),document.body.classList.add("no-scroll"),"modal"===this.context||"return"===this.context){const openType="modal"===this.context?"open":"open-return";this.sourceModal.classList.remove(openType)}this.initializeInputFields(),"form"===this.context&&document.getElementById("date-manufacture")?.value&&(this.modalCalcDateStart.value=document.getElementById("date-manufacture").value)}initializeInputFields(){this.modalCalcDateStart=document.getElementById("modal-date-start"),this.modalDays=document.getElementById("modal-days"),this.modalMonths=document.getElementById("modal-months"),this.modalCalcDateEnd=document.getElementById("modal-date-end"),this.addButton=document.getElementById("modal-add"),this.modalCalcDateStart&&this.modalDays&&this.modalMonths&&this.modalCalcDateEnd&&this.addButton||console.error("Не все элементы калькулятора найдены")}addCalculatorListeners(calculatorModal){if(calculatorModal.addEventListener("submit",e=>this.handleCalculatorSubmit(e)),calculatorModal.addEventListener("click",e=>{e.target.closest("#modal-add")&&this.handleAddDate(e)}),"form"===this.context){const arrow=createArrow();arrow&&(calculatorModal.prepend(arrow),arrow.addEventListener("click",e=>{e.preventDefault(),this.closeCalculator(),this.calculatorButton?.focus()}))}}handleCalculatorSubmit(e){if(e.preventDefault(),this.validateCalculator()){const endDate=calculateExpirationDate(this.modalCalcDateStart.value,this.modalDays.value,this.modalMonths.value);this.modalCalcDateEnd.textContent=endDate,this.addButton.disabled=!1}else this.addButton.disabled=!0}validateCalculator(){return validateCalculator(this.modalCalcDateStart,this.modalDays,this.modalMonths)}handleAddDate(e){if(e.preventDefault(),!this.validateCalculator())return;const endDate=dateToAddForm(this.modalCalcDateStart.value,this.modalDays.value,this.modalMonths.value);this.fillSourceFields(endDate),this.closeCalculator(),this.calculatorButton?.focus()}fillSourceFields(endDate){const formattedDate=this.formatDateForInput(endDate);switch(this.context){case"modal":this.sourceModal.dateProd.value=this.modalCalcDateStart.value,this.sourceModal.date.value=formattedDate,this.sourceModal.classList.add("open");break;case"return":this.sourceModal.dateProd.value=this.modalCalcDateStart.value,this.sourceModal.date.value=formattedDate,this.sourceModal.classList.add("open-return");break;case"form":document.getElementById("date-manufacture")&&(document.getElementById("date-manufacture").value=this.modalCalcDateStart.value),document.getElementById("end-date")&&(document.getElementById("end-date").value=formattedDate)}}formatDateForInput(date){if(!(date instanceof Date))return console.error("Неверный формат даты"),"";return`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`}handleArrowBack(e){e.preventDefault(),"modal"===this.context?this.sourceModal.classList.add("open"):"return"===this.context&&this.sourceModal.classList.add("open-return"),this.closeCalculator(),this.calculatorButton?.focus()}closeCalculator(){this.calculatorModal&&this.calculatorModal.classList.remove("open"),document.body.classList.remove("no-scroll"),this.calculatorModal=null,this.sourceModal=null,this.context=null,this.calculatorButton=null}createModalCalculatorComponent(){return`\n    \n    <h2 class="modal__title">Калькулятор</h2>\n    <label for="modal-date-start">Дата изготовления</label>\n    <input class="input-field calculator__date-start" id="modal-date-start" type="date" max="${DateUtils.getTodayDateString()}" style="width: 100%;">\n    <label for="modal-days">Срок годности, дней</label>\n    <input class="input-field calculator__days" id="modal-days" type="number" min="1" style="width: 100%;">\n    <label for="modal-months">Срок годности, месяцев</label> \n    <input class="input-field calculator__months" id="modal-months" type="number" min="1" style="width: 100%;">\n    <label for="modal-date-end">Дата окончания СГ</label>\n    <div class="input-field date-end" id="modal-date-end" aria-live="polite"></div>\n    <button class="btn calculator__btn" id="modal-calc-btn" type="submit">OK</button>\n    <button class="btn" id="modal-add" disabled>Добавить дату</button>\n  `}}