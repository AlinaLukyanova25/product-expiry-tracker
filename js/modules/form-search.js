export class FormSearch{constructor({searchInput:searchInput,formSearchBtn:formSearchBtn,formSearchClear:formSearchClear,sections:sections,productsDB:productsDB,filterSelect:filterSelect,renderAllProducts:renderAllProducts,renderProductsToArchive:renderProductsToArchive,renderProductsToSection:renderProductsToSection,calculateDateDifference:calculateDateDifference}){this.searchInput=searchInput,this.formSearchBtn=formSearchBtn,this.formSearchClear=formSearchClear,this.sections=sections,this.productsDB=productsDB,this.filterSelect=filterSelect,this.renderAllProducts=renderAllProducts,this.renderProductsToArchive=renderProductsToArchive,this.renderProductsToSection=renderProductsToSection,this.calculateDateDifference=calculateDateDifference,this.isSearching=!1,this.init()}init(){this.setupEventListeners(),this.setupSortListener()}setupEventListeners(){this.formSearchBtn.addEventListener("click",e=>this.searchProducts(e)),this.searchInput.addEventListener("touchstart",e=>{e.preventDefault(),this.searchInput.focus()},{passive:!1}),this.searchInput.addEventListener("keydown",e=>{"Enter"!==e.key&&13!==e.keyCode||(e.preventDefault(),this.formSearchBtn.click())}),this.searchInput.addEventListener("input",()=>this.handleInput()),this.searchInput.addEventListener("focus",()=>this.handleFocus()),this.searchInput.addEventListener("blur",()=>this.handleBlur()),this.formSearchClear.addEventListener("click",e=>this.handleClear(e))}setupSortListener(){this.filterSelect?(this.filterSelect.addEventListener("change",()=>this.renderAllProducts(this.productsDB,this.filterSelect,this.sections)),this.searchInput.value="",this.formSearchClear.style.display="none"):console.error("Фильтр сортировки не найден")}async searchProducts(e){if(e.preventDefault(),!this.isSearching){this.isSearching=!0;try{const searchTerm=this.searchInput.value.trim();if(!searchTerm)return;this.searchInput.removeEventListener("blur",this.handleBlur),this.searchInput.blur(),this.formSearchClear.style.display="none",this.searchInput.removeEventListener("input",this.handleInput);const allProducts=await this.productsDB.getAllProducts(),productsArray=Array.from(allProducts),activeSection=this.getActiveSection();if(!activeSection)return;let filteredProducts=[];activeSection.classList.contains("section--archive")?filteredProducts=productsArray.filter(prod=>prod.inArchive):activeSection.classList.contains("section--expired")?filteredProducts=productsArray.filter(prod=>calculateDateDifference(prod.expiryDate)<=0&&!prod.inArchive):activeSection.classList.contains("section--soon")?filteredProducts=productsArray.filter(prod=>calculateDateDifference(prod.expiryDate)<=3&&calculateDateDifference(prod.expiryDate)>0&&!prod.inArchive):activeSection.classList.contains("section--fresh")?filteredProducts=productsArray.filter(prod=>calculateDateDifference(prod.expiryDate)>3&&!prod.inArchive):activeSection.classList.contains("section--all")&&(filteredProducts=productsArray.filter(prod=>!prod.inArchive)),await this.performSearch(filteredProducts,activeSection,searchTerm)}finally{setTimeout(()=>{this.isSearching=!1,this.searchInput.addEventListener("input",()=>this.handleInput()),this.searchInput.addEventListener("blur",()=>this.handleBlur())},300)}}}getActiveSection(){const sectionKeys=Object.keys(this.sections);for(const key of sectionKeys)if(this.sections[key]&&"block"===this.sections[key].style.display)return this.sections[key];return null}async performSearch(products,section,searchTerm){if(!products||!section)return;const list=section.querySelector("ul");if(!list)return;list.innerHTML="";const searchTermLower=searchTerm.toLowerCase(),matchingProducts=products.filter(product=>product.name.toLowerCase().includes(searchTermLower));0!==matchingProducts.length?matchingProducts.forEach(product=>{product.inArchive?this.renderProductsToArchive(section,product):this.renderProductsToSection(section,product)}):list.innerHTML="<p>Ничего не найдено...</p>"}handleInput(){const hasValue=""!==this.searchInput.value.trim();this.formSearchClear.style.display=hasValue?"block":"none",hasValue||this.renderAllProducts(this.productsDB,this.filterSelect,this.sections)}handleFocus(){const rect=this.searchInput.getBoundingClientRect();this.formSearchClear.style.left=rect.x+rect.width-30+"px";const verticalCenter=rect.y+rect.height/2;this.formSearchClear.style.top=Math.round(verticalCenter)-10+"px",this.formSearchClear.style.display=this.searchInput.value?"block":"none"}handleBlur(){this.searchInput.value.trim()?setTimeout(()=>this.searchInput.focus(),100):this.formSearchClear.style.display="none"}handleClear(e){e.target.closest(".form-search__remove")&&(e.preventDefault(),this.searchInput.value&&(this.searchInput.value="",this.renderAllProducts(this.productsDB,this.filterSelect,this.sections)),this.searchInput.blur(),this.formSearchClear.style.display="none")}}