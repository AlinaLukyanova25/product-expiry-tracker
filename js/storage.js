class ProductsDB{static#instance=null;static DB_NAME="ProductsDB";static DB_VERSION=1;static STORE_NAME="products";#db=null;#isInitialized=!1;#initPromise=null;constructor(){if(ProductsDB.#instance)return ProductsDB.#instance;ProductsDB.#instance=this}static getInstance(){return ProductsDB.#instance||(ProductsDB.#instance=new ProductsDB),ProductsDB.#instance}async initialize(){return this.#isInitialized?this.#db:(this.#initPromise||(this.#initPromise=new Promise((resolve,reject)=>{const request=indexedDB.open(ProductsDB.DB_NAME,ProductsDB.DB_VERSION);request.onupgradeneeded=event=>{if(this.#db=event.target.result,!this.#db.objectStoreNames.contains(ProductsDB.STORE_NAME)){const store=this.#db.createObjectStore(ProductsDB.STORE_NAME,{keyPath:"id",autoIncrement:!0});store.createIndex("name_idx","name",{unique:!1}),store.createIndex("date_idx","expiryDate",{unique:!1}),console.log("Хранилище создано")}},request.onsuccess=event=>{this.#db=event.target.result,this.#isInitialized=!0,console.log("База данных открыта"),resolve(this.#db)},request.onerror=event=>{console.log("Ошибка открытия базы"),reject(event.target.error)}})),this.#initPromise)}async addProduct(product){return await this.ensureInitialized(),new Promise((resolve,reject)=>{const request=this.#db.transaction(ProductsDB.STORE_NAME,"readwrite").objectStore(ProductsDB.STORE_NAME).add(product);request.onsuccess=()=>{console.log("Продукт добавлен, id:",request.result),resolve(request.result)},request.onerror=event=>{console.error("Ошибка добавления:",event.target.error),reject(event.target.error)}})}async getAllProducts(){return await this.ensureInitialized(),new Promise((resolve,reject)=>{const request=this.#db.transaction(ProductsDB.STORE_NAME,"readonly").objectStore(ProductsDB.STORE_NAME).getAll();request.onsuccess=()=>{resolve(request.result)},request.onerror=event=>{console.error("Ошибка получения:",event.target.error),reject(event.target.error)}})}async updateProduct(product){return await this.ensureInitialized(),new Promise((resolve,reject)=>{const request=this.#db.transaction(ProductsDB.STORE_NAME,"readwrite").objectStore(ProductsDB.STORE_NAME).put(product);request.onsuccess=()=>{console.log("Продукт обновлен"),resolve()},request.onerror=event=>{console.error("Ошибка обновления:",event.target.error),reject(event.target.error)}})}async deleteProduct(id){return await this.ensureInitialized(),new Promise((resolve,reject)=>{const request=this.#db.transaction(ProductsDB.STORE_NAME,"readwrite").objectStore(ProductsDB.STORE_NAME).delete(id);request.onsuccess=()=>{console.log("Продукт удален"),resolve()},request.onerror=event=>{console.error("Ошибка удаления:",event.target.error),reject(event.target.error)}})}async getProductById(id){return await this.ensureInitialized(),new Promise((resolve,reject)=>{const request=this.#db.transaction(ProductsDB.STORE_NAME,"readonly").objectStore(ProductsDB.STORE_NAME).get(id);request.onsuccess=()=>{resolve(request.result)},request.onerror=event=>{console.error("Ошибка получения продукта:",event.target.error),reject(event.target.error)}})}async ensureInitialized(){this.#isInitialized||await this.initialize()}getDB(){return this.#db}isInitialized(){return this.#isInitialized}}export const productsDB=ProductsDB.getInstance();