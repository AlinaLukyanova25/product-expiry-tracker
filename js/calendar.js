import{productsDB}from"./storage.js";import{productCategoryTranslation}from"./products.js";import{formatDateCard,DateUtils}from"./utils/date-utils.js";import{elementCheck,createArrow}from"./utils/dom-utils.js";export class ExpiryCalendar{constructor(productsDB){this.currentDate=new Date,this.productsDB=productsDB,this.products=[],this.currentSelectedDate=null,this.currentModalProducts=null,this.init(),this.modalContainer=document.querySelector(".modal-calendar"),this.modalContainer.addEventListener("click",async e=>{e.target.closest(".modal-calendar__close")&&this.closeModal(),e.target.closest(".calendar-item")&&await this.openModalProduct(e)})}async init(){await this.loadProducts(),this.renderCalendar(),this.setupEventListeners()}async loadProducts(){try{const collection=await this.productsDB.getAllProducts();this.products=Array.from(collection)}catch{console.error("Ошибка загрузки продуктов для календаря: ",error),this.products=[]}}async update(){await this.loadProducts(),this.renderCalendar()}updateMonthHeader(){const currentMonthEl=document.getElementById("current-month");elementCheck(currentMonthEl,"заголовок календаря");const monthName=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"][this.currentDate.getMonth()],year=this.currentDate.getFullYear();currentMonthEl.textContent=`${monthName} ${year}`}renderCalendar(){const calendarEl=document.getElementById("calendar");elementCheck(calendarEl,"календарь"),calendarEl.innerHTML="";const firstDay=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),1),lastDay=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth()+1,0),dayInMonth=lastDay.getDate(),startingDay=firstDay.getDay(),startOffset=0===startingDay?6:startingDay-1;for(let i=0;i<startOffset;i++){const lastMonthFirstDay=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),0-(startOffset-1)+i),day=lastMonthFirstDay.getDate(),dayEl=this.createDayComponent(lastMonthFirstDay,day,!0);calendarEl.insertAdjacentHTML("beforeend",dayEl)}for(let day=1;day<=dayInMonth;day++){const date=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),day),dayEl=this.createDayComponent(date,day);calendarEl.insertAdjacentHTML("beforeend",dayEl)}const endingDay=lastDay.getDay(),nextMonthDays=6-(0===endingDay?6:endingDay-1);if(nextMonthDays>0)for(let i=0;i<nextMonthDays;i++){const nextMonthFirstDay=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth()+1,i+1),day=nextMonthFirstDay.getDate(),dayEl=this.createDayComponent(nextMonthFirstDay,day,!0);calendarEl.insertAdjacentHTML("beforeend",dayEl)}this.updateMonthHeader(),this.attachEventListeners()}createDayComponent(date,dayNumber,nextMonth=!1){if(!date)return`\n            <div tabindex="0" class="calendar__day empty" style="color: gray;">\n            ${dayNumber}\n            </div>\n            `;const today=new Date,expiryCount=this.countProductsBeforeDate(date),dateString=this.formatDateToString(date);return`\n        <div tabindex="0"\n        ${nextMonth?'class="calendar__day empty" style="color: gray;"':date.getDate()===today.getDate()&&date.getMonth()===today.getMonth()&&date.getFullYear()===today.getFullYear()?'class="calendar__day today"':'class="calendar__day"'}\n        data-date="${dateString}"\n        >\n        ${dayNumber}\n        ${expiryCount>0?`<span class="expiry-badge" ${this.definesColorsComponent(date)}>${expiryCount}</span>`:""}\n        </div>\n        `}formatDateToString(date){return`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`}attachEventListeners(){document.addEventListener("click",e=>{const dayEl=e.target.closest(".calendar__day");if(dayEl){const date=new Date(dayEl.dataset.date);this.handleDayClick(date)}})}countProductsBeforeDate(date){if(!this.products)throw new Error("Массив продуктов не найден");return this.products.filter(product=>{if(!product.expiryDate)return!1;const expiryDate=new Date(product.expiryDate);return isNaN(expiryDate.getTime())?void 0:expiryDate.getFullYear()===date.getFullYear()&&expiryDate.getMonth()===date.getMonth()&&expiryDate.getDate()===date.getDate()&&!product.inArchive}).length}definesColorsComponent(date){const today=new Date;return date<today||date.getDate()===today.getDate()&&date.getMonth()===today.getMonth()&&date.getFullYear()===today.getFullYear()?'style="background-color: #ff4757;"':Math.ceil((date-today)/864e5)<=3?'style="background-color: #f39c12;"':'style="background-color: #27ae60;"'}handleDayClick(date){const productsOnDate=this.getProductsByDate(date);this.showProductsModal(productsOnDate,date)}getProductsByDate(date){return this.products.filter(product=>{if(!product.expiryDate)return!1;const expiryDate=new Date(product.expiryDate);return isNaN(expiryDate.getTime())?void 0:expiryDate.getFullYear()===new Date(date).getFullYear()&&expiryDate.getMonth()===new Date(date).getMonth()&&expiryDate.getDate()===new Date(date).getDate()&&!product.inArchive})}closeModal(){this.modalContainer.classList.remove("open-calendar"),document.body.classList.remove("no-scroll")}showProductsModal(products,date){this.currentSelectedDate=date,this.currentModalProducts=products;const modalCalendar=document.querySelector(".modal-calendar");modalCalendar.classList.add("open-calendar"),document.body.classList.add("no-scroll"),modalCalendar.innerHTML=`\n        <div class="modal-calendar__content">\n        <h3 class="modal__title">Товары до ${new Date(date).toLocaleDateString()}</h3>\n        ${products.length>0?`<ul id="calendar-list">${products.map(p=>`${this.createProductCardComponent(p,date)}`).join("")}</ul>`:"<p>Нет товаров с истекающим сроком</p>"}\n        <button class="btn modal-calendar__close" style="width: 100%;">Закрыть</button>\n        </div>\n        `}async openModalProduct(e){const modal=document.getElementById("modal"),sections=document.querySelectorAll("section"),target=e.target.closest("li");if(!target)return;const id=+target.dataset.id,product=this.currentModalProducts.find(prod=>prod.id===id);if(!product)return;const html=this.toModalComponent(product,id);modal.innerHTML=html,modal.firstElementChild.style.paddingLeft="28px",modal.firstElementChild.style.marginBottom="12px";const arrow=createArrow();modal.prepend(arrow),modal.classList.add("open"),document.body.classList.add("no-scroll"),document.querySelector(".modal-calendar").classList.remove("open-calendar"),this.handleModalSubmit&&modal.removeEventListener("submit",this.handleModalSubmit),this.handleModalSubmit=async submitEvent=>{submitEvent.preventDefault(),console.log("SUBMIT ВЫЗВАН"),setTimeout(async()=>{try{const updateProducts=await productsDB.getAllProducts();if(this.products=updateProducts,this.renderCalendar(),this.currentSelectedDate){const currentProducts=this.getProductsByDate(this.currentSelectedDate);this.currentModalProducts=currentProducts;const modalCalendar=document.querySelector(".modal-calendar"),calendarList=modalCalendar.querySelector("#calendar-list");calendarList&&(currentProducts.length>0?calendarList.innerHTML=currentProducts.map(p=>this.createProductCardComponent(p,this.currentSelectedDate)).join(""):calendarList.innerHTML="<p>Нет товаров с истекающим сроком годности </p>"),sections.forEach(element=>{modalCalendar&&"none"!==element.style.display&&"calendar"===element.className&&(modalCalendar.classList.add("open-calendar"),document.body.classList.add("no-scroll"))})}modal.classList.remove("open")}catch(error){console.error("Ошибка в handleModalSubmit:",error)}modal.removeEventListener("submit",this.handleModalSubmit),this.handleModalSubmit=null},100)},modal.addEventListener("submit",this.handleModalSubmit),arrow.addEventListener("click",e=>{e.preventDefault(),sections.forEach(element=>{"none"!==element.style.display&&"calendar"===element.className&&(document.querySelector(".modal-calendar").classList.add("open-calendar"),modal.classList.remove("open"),document.body.classList.remove("no-scroll"))})})}createProductCardComponent(product,date){const categoryDisplay=productCategoryTranslation[product.category]||product.category;return`\n        <li class="card calendar-item" data-id="${product.id}" tabindex="0">\n        <div class="image-preview" id="preview-${product.id}">\n        ${product.image?`<img src="${product.image}" alt="${product.name}">`:""}\n        </div>\n        <div class="modal-calendar__list-content">\n\n        <div class="calendar-item__header">\n        <h3 class="card__title">${product.name}</h3>\n        </div>\n        <div class="calendar-item__footer">\n        <div>До ${formatDateCard(date)}</div>\n        <div>${categoryDisplay}</div>\n        </div>\n\n        </div>\n        </li>\n        `}changeMonth(direction){this.currentDate.setDate(1),this.currentDate.setMonth(this.currentDate.getMonth()+direction),this.renderCalendar()}setupEventListeners(){document.getElementById("prev-month").addEventListener("click",()=>this.changeMonth(-1)),document.getElementById("next-month").addEventListener("click",()=>this.changeMonth(1))}toModalComponent(card,id){return`\n        <h2 class="modal__title">${card.name}</h2>\n        <div class="image-preview" id="preview-${card.id}" tabindex="0">\n            ${card.image?`<img src="${card.image}" alt="${card.name}">`:""}\n            </div>\n          <input type="file"\n            id="file-${card.id}"\n            accept="image/*"\n            style="display: none;">\n        <label class="modal__label" for="modal-date-production">Дата изготовления</label>\n        <input class="input-field modal__date-production" id="modal-date-production" type="date" name="dateProd" data-id="${id}" max="${DateUtils.getTodayDateString()}" value="${card.productionDate}" style="width: 100%;" required>\n        <div class="modal__auto-calc">\n        <label class="modal__label" for="auto">Автоматический расчет по</label>\n        <select class="input-field modal__select" id="auto" style="width: 100%;">\n        <option value="" disabled selected>Выберите вариант</option>\n        <option value="day">дням</option>\n        <option value="month">месяцам</option>\n        </select>\n        <button class="modal__calculator"><img class="modal__img" src="img/calculator.svg" alt="Калькулятор"></button>\n        </div>\n        <button class="btn modal__button--calc">Автоматический расчет</button>\n        <label class="modal__label" for="modal-date">Дата окончания срока</label>\n        <input class="input-field modal__end-date" id="modal-date" type="date" name="date" data-id="${id}" min="${DateUtils.getTomorrowDateString()}" value="${card.expiryDate}" style="width: 100%;" required>\n        <button class="btn modal__button" type="submit">Сохранить изменения</button>\n        <button class="btn modal__push-archive">Добавить в архив</button>\n        `}}document.getElementById("backdrop-calendar").addEventListener("click",()=>{document.querySelector(".modal-calendar").classList.remove("open-calendar"),document.body.classList.remove("no-scroll")});